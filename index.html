<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Golden 2026 Celebration</title>
    <style>
        /* --- RESET & BASE --- */
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* --- 3D CANVAS --- */
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* --- UI LAYER --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }

        /* --- ADS --- */
        .ad-strip { pointer-events: auto; width: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 100; }
        
        /* --- PANEL (CENTERED AT BOTTOM) --- */
        .side-panel { 
            pointer-events: auto; 
            position: absolute; 
            bottom: 60px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.0); 
            backdrop-filter: none; 
            border: none;
            box-shadow: none;
            color: white; 
            transition: all 0.4s; 
            z-index: 90; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .side-panel h3 { 
            margin: 0 0 15px 0; 
            font-weight: 600; 
            font-size: 1.3rem; 
            color: #ffd700; 
            text-align: center; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            width: 100%;
        }
        
        input { width: 100%; padding: 12px; margin-bottom: 12px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 10px; box-sizing: border-box; outline: none; font-size: 1rem; backdrop-filter: blur(4px); }
        input:focus { border-color: #ffd700; background: rgba(0,0,0,0.8); }

        .file-label { width: 100%; display: block; padding: 12px; background: rgba(0,0,0,0.6); border-radius: 10px; margin-bottom: 20px; font-size: 0.9rem; cursor: pointer; text-align: center; border: 1px dashed rgba(255,255,255,0.4); transition: background 0.3s; backdrop-filter: blur(4px); box-sizing: border-box; }
        .file-label:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
        input[type="file"] { display: none; }

        button { width: 100%; padding: 14px; border: none; border-radius: 30px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-apply { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #222; box-shadow: 0 4px 15px rgba(255, 170, 0, 0.3); }
        .btn-apply:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5); }
        
        /* SHARE ICONS CONTAINER */
        #share-container {
            display: none; /* Hidden initially */
            flex-direction: row;
            justify-content: center;
            gap: 20px;
            width: 100%;
            margin-top: 10px;
        }

        .share-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
        }
        .share-icon:hover { transform: scale(1.1); }
        .share-icon:active { transform: scale(0.9); }

        .icon-wa { background: #25D366; color: white; }
        .icon-copy { background: #ffffff; color: #333; }

        #status { font-size: 0.8rem; color: #aaa; text-align: center; margin-top: 5px; min-height: 15px; text-shadow: 0 1px 2px black;}
        
        /* --- LOADING OVERLAY --- */
        #loader-overlay { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; 
            z-index: 200; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: gold; 
            transition: opacity 0.5s; 
            pointer-events: auto; 
        }
        
        #loader-ad-container { margin-bottom: 30px; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        #loader-text { font-size: 1.5rem; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; transition: transform 0.2s; }

        @media (max-width: 768px) {
            .side-panel { width: 90%; bottom: 50px; }
            .side-panel h3 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div id="loader-ad-container">
            <script> atOptions = { 'key' : '04160f66b3308e7b2ef3b7cbde435a66', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} }; </script>
            <script src="https://www.highperformanceformat.com/04160f66b3308e7b2ef3b7cbde435a66/invoke.js"></script>
        </div>
        <div id="loader-text">Loading Magic...</div>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="ad-strip top">
             <script> atOptions = { 'key' : '04160f66b3308e7b2ef3b7cbde435a66', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} }; </script>
             <script src="https://www.highperformanceformat.com/04160f66b3308e7b2ef3b7cbde435a66/invoke.js"></script>
        </div>

        <div class="side-panel" id="panel">
            <h3>Make a Wish âœ¨</h3>
            <input type="text" id="inpName" placeholder="Your Name..." maxlength="20">
            <label for="inpPhoto" class="file-label" id="fileLabel"><span style="font-size:1.2rem">ðŸ“¸</span><br>Add Photo (Optional)</label>
            <input type="file" id="inpPhoto" accept="image/*">

            <button class="btn-apply" id="btnGen" onclick="generateWish()">Generate 3D Wish</button>
            
            <div id="share-container">
                <div class="share-icon icon-wa" onclick="shareWhatsapp()" title="Share on WhatsApp">ðŸ’¬</div>
                <div class="share-icon icon-copy" onclick="nativeShare()" title="Copy Link">ðŸ“‹</div>
            </div>

            <div id="status"></div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCFXQdHH4hsx89kISK2ZV9VmzadqKeju5vd9rsCLnREs-ySWXDFM6p0OYLWr8Xe6_ImQ/exec"; 

        // --- COUNTDOWN LOGIC ---
        function triggerCountdown() {
            const txt = document.getElementById('loader-text');
            const overlay = document.getElementById('loader-overlay');
            let count = 3;
            txt.style.fontSize = "4rem"; txt.style.color = "#ffd700"; txt.innerText = count;

            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    txt.innerText = count;
                } else {
                    clearInterval(timer);
                    txt.innerText = "1";
                    setTimeout(() => {
                        overlay.style.opacity = 0;
                        setTimeout(() => overlay.style.display = 'none', 500);
                    }, 800);
                }
            }, 800);
        }

        /* --- 3D SETUP --- */
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020205, 0.015);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 25);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.enablePan = false; controls.maxDistance = 40; controls.minDistance = 10; controls.autoRotate = true; controls.autoRotateSpeed = 0.8;

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.2; bloomPass.strength = 0.6; bloomPass.radius = 0.5;
        composer.addPass(bloomPass);

        scene.add(new THREE.AmbientLight(0x404040));
        const dl = new THREE.DirectionalLight(0xffffff, 2); dl.position.set(5, 5, 5); scene.add(dl);

        /* --- OBJECTS (UPDATED SIZE) --- */
        const frameGroup = new THREE.Group(); scene.add(frameGroup);
        const goldMat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 1, roughness: 0.3, emissive: 0xaa6600, emissiveIntensity: 0.2 });
        
        // ** CHANGE: Shorter Frame (9.2 x 9.2) - Square **
        frameGroup.add(new THREE.Mesh(new THREE.BoxGeometry(9.2, 9.2, 0.2), goldMat));

        // ** CHANGE: Shorter Photo Plane (9 x 9) **
        const photoGeo = new THREE.PlaneGeometry(9, 9);
        const defCanvas = document.createElement('canvas'); defCanvas.width = 512; defCanvas.height = 512;
        const ctx = defCanvas.getContext('2d'); ctx.fillStyle = "#111"; ctx.fillRect(0,0,512,512);
        ctx.fillStyle = "#fff"; ctx.font = "bold 60px Arial"; ctx.textAlign = "center";
        ctx.fillText("YOUR", 256, 220); ctx.fillText("PHOTO", 256, 290);
        const photoPlane = new THREE.Mesh(photoGeo, new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(defCanvas) }));
        photoPlane.position.z = 0.11; frameGroup.add(photoPlane);

        let textGroup = new THREE.Group(); scene.add(textGroup);
        let loadedFont = null;
        const fontLoader = new FontLoader();
        
        fontLoader.load('https://threejs.org/examples/fonts/optimer_bold.typeface.json', (font) => {
            loadedFont = font;
            const params = new URLSearchParams(window.location.search);
            const uid = params.get('wish');
            if(uid) {
                checkForSharedWish(uid);
            } else {
                update3DText("Someone"); 
                triggerCountdown();
            }
        });

        /* --- FIREWORKS --- */
        const fireworks = [];
        function createFirework() {
            const x = (Math.random() - 0.5) * 40; const y = (Math.random() - 0.5) * 20; const z = (Math.random() - 0.5) * 20 - 10;
            const color = new THREE.Color().setHSL(Math.random(), 1, 0.5);
            const particleCount = 40 + Math.random() * 40;
            const pos = []; const vels = [];
            for(let i=0; i<particleCount; i++){
                pos.push(x, y, z);
                const th = Math.random() * Math.PI * 2; const ph = Math.random() * Math.PI; const sp = 0.2 + Math.random() * 0.3;
                vels.push(sp * Math.sin(ph) * Math.cos(th), sp * Math.sin(ph) * Math.sin(th), sp * Math.cos(ph));
            }
            const geo = new THREE.BufferGeometry(); geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const pts = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.4, color: color, transparent: true, blending: THREE.AdditiveBlending }));
            scene.add(pts); fireworks.push({ mesh: pts, vels: vels, life: 1.0 });
        }

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate); controls.update();
            const t = clock.getElapsedTime();
            frameGroup.position.y = Math.sin(t * 2.5) * 0.5; 
            textGroup.position.y = Math.sin((t * 2.5) + 1) * 0.5;
            
            if(Math.random() < 0.04) createFirework();
            for (let i = fireworks.length - 1; i >= 0; i--) {
                const fw = fireworks[i]; fw.life -= 0.015; fw.mesh.material.opacity = fw.life;
                const p = fw.mesh.geometry.attributes.position.array;
                for(let k=0; k<fw.vels.length/3; k++){
                    fw.vels[k*3 + 1] -= 0.005; 
                    p[k*3] += fw.vels[k*3]; p[k*3+1] += fw.vels[k*3+1]; p[k*3+2] += fw.vels[k*3+2];
                }
                fw.mesh.geometry.attributes.position.needsUpdate = true;
                if(fw.life <= 0){ scene.remove(fw.mesh); fireworks.splice(i, 1); }
            }
            composer.render();
        }
        animate();

        /* --- LOGIC --- */
        let base64Img = null;
        let generatedUID = null;

        function resizeImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxDim = 800; 
                    if (width > height) { if (width > maxDim) { height *= maxDim / width; width = maxDim; } } 
                    else { if (height > maxDim) { width *= maxDim / height; height = maxDim; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('inpPhoto').addEventListener('change', (e) => {
            if(e.target.files[0]){
                const f = e.target.files[0];
                document.getElementById('fileLabel').innerHTML = "â³ Processing...";
                resizeImage(f, (resizedBase64) => {
                    base64Img = resizedBase64;
                    document.getElementById('fileLabel').innerHTML = "âœ… Photo Ready";
                    update3DPhoto(base64Img);
                });
            }
        });

        window.generateWish = function() {
            const name = document.getElementById('inpName').value;
            const status = document.getElementById('status');
            if(!name && !base64Img) { status.innerText = "Please write a name or pick a photo."; status.style.color = "#ff5555"; return; }
            if(name) update3DText(name);

            status.style.color = "#aaa"; status.innerText = "Saving... (Wait 5s)";
            document.getElementById('btnGen').disabled = true;

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                redirect: "follow", 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ name: name || "Anonymous", image: base64Img || "No Image" })
            })
            .then(res => res.json())
            .then(data => {
                if(data.result === "success") {
                    generatedUID = data.uid;
                    status.innerText = "Wish Saved! Select an option below:"; status.style.color = "#44ff44";
                    document.getElementById('btnGen').style.display = 'none';
                    // SHOW ICONS
                    document.getElementById('share-container').style.display = 'flex';
                } else { throw new Error(data.error || "Script Error"); }
            })
            .catch(e => {
                console.error(e);
                status.innerText = "Error Saving. (Deploy script as New Version)";
                status.style.color = "red";
                document.getElementById('btnGen').disabled = false;
            });
        }

        function checkForSharedWish(uid) {
            document.querySelector('.side-panel h3').innerText = "You have a Wish! âœ¨";
            document.getElementById('inpName').style.display = 'none';
            document.getElementById('fileLabel').style.display = 'none';
            document.getElementById('btnGen').innerText = "Create Your Own";
            document.getElementById('btnGen').onclick = () => { window.location.href = window.location.pathname; }; 
            
            fetch(`${GOOGLE_SCRIPT_URL}?uid=${uid}`)
            .then(res => res.json())
            .then(data => {
                if(data.result === "success") {
                    if(data.name) update3DText(data.name);
                    if(data.image) {
                        new THREE.TextureLoader().load(data.image, (tex) => {
                             applyTexture(tex);
                             triggerCountdown();
                        }, undefined, () => triggerCountdown());
                    } else { triggerCountdown(); }
                } else { triggerCountdown(); }
            })
            .catch(() => triggerCountdown());
            
            setTimeout(triggerCountdown, 8000);
        }

        // --- UPDATED TEXT POSITIONING (For Shorter Frame) ---
        function update3DText(name) {
            if(!loadedFont) return;
            textGroup.clear();
            
            // 1. TOP LINE (Moved closer to square frame)
            const nameGeo = new TextGeometry(name, { font: loadedFont, size: 2.0, height: 0.3, bevelEnabled:true, bevelThickness:0.05, bevelSize:0.02 });
            nameGeo.center();
            const nameMesh = new THREE.Mesh(nameGeo, goldMat);
            nameMesh.position.set(0, 7.5, 0); // Lowered
            textGroup.add(nameMesh);

            // 2. MIDDLE LINE
            const midGeo = new TextGeometry("is wishing you", { font: loadedFont, size: 0.7, height: 0.1 });
            midGeo.center();
            const midMesh = new THREE.Mesh(midGeo, new THREE.MeshStandardMaterial({ color: 0xffffff }));
            midMesh.position.set(0, 5.5, 0); // Lowered
            textGroup.add(midMesh);

            // 3. BOTTOM LINE (Smaller Font, Closer to Frame)
            const bottomGeo = new TextGeometry("Happy New Year 2026", { 
                font: loadedFont, 
                size: 1.1, // ** SMALLER FONT SIZE **
                height: 0.3, bevelEnabled:true, bevelThickness:0.05, bevelSize:0.02 
            });
            bottomGeo.center();
            const bottomMesh = new THREE.Mesh(bottomGeo, new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x00aaff, emissiveIntensity: 0.5 }));
            bottomMesh.position.set(0, -6.5, 0); // Moved UP closer to frame
            textGroup.add(bottomMesh);
        }

        // --- ASPECT RATIO FIX FOR SQUARE FRAME ---
        function applyTexture(tex) {
            tex.colorSpace = THREE.SRGBColorSpace;
            const asp = tex.image.width / tex.image.height;
            photoPlane.scale.set(1, 1, 1);
            
            // Since frame is now Square (1:1):
            if(asp > 1) {
                // Image is wide -> Fit Width, Shrink Height (Vertical Bars will appear)
                // OR Fit Height, Crop Width? Usually standard "Fit Center":
                photoPlane.scale.set(1, 1/asp, 1);
            } else {
                // Image is tall -> Fit Height, Shrink Width
                photoPlane.scale.set(asp, 1, 1);
            }
            photoPlane.material.map = tex; 
            photoPlane.material.needsUpdate = true;
        }

        function update3DPhoto(b64) {
            new THREE.TextureLoader().load(b64, (tex) => { applyTexture(tex); });
        }

        window.nativeShare = function() {
            const url = window.location.origin + window.location.pathname + "?wish=" + generatedUID;
            navigator.clipboard.writeText(url);
            alert("Link copied! Send it to your friends.");
        }
        window.shareWhatsapp = function() {
            const url = window.location.origin + window.location.pathname + "?wish=" + generatedUID;
            window.open(`https://wa.me/?text=${encodeURIComponent("*Happy New Year 2026!* ðŸŽ†\nI made a 3D wish for you:\n" + url)}`, '_blank');
        }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight); });
    </script>
</body>
</html>
